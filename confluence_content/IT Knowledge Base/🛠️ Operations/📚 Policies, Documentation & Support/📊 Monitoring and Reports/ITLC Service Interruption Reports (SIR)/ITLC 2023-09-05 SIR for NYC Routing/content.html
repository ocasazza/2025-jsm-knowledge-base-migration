<ac:layout>
 <ac:layout-section ac:type="single">
  <ac:layout-cell>
   <p>
    <br/>
   </p>
   <ac:structured-macro ac:macro-id="6041cfab-a8b7-40c8-aa32-0229b207b0df" ac:name="excerpt" ac:schema-version="1">
    <ac:parameter ac:name="atlassian-macro-output-type">
     INLINE
    </ac:parameter>
    <ac:rich-text-body>
     <p>
      SIR for NYC Routing, multiple dates in september.
     </p>
    </ac:rich-text-body>
   </ac:structured-macro>
   <p class="auto-cursor-target">
    <br/>
   </p>
  </ac:layout-cell>
 </ac:layout-section>
 <ac:layout-section ac:type="two_equal">
  <ac:layout-cell>
   <p class="auto-cursor-target">
    <br/>
   </p>
   <ac:structured-macro ac:macro-id="b2a57857-7f56-44d2-a0d4-91b3d7ebfcbf" ac:name="toc-zone" ac:schema-version="1">
    <ac:rich-text-body>
     <p>
      <ac:structured-macro ac:macro-id="58b18781-a929-4005-a5e0-2ef23adca3fe" ac:name="toc" ac:schema-version="1">
      </ac:structured-macro>
     </p>
    </ac:rich-text-body>
   </ac:structured-macro>
   <p class="auto-cursor-target">
    <br/>
   </p>
  </ac:layout-cell>
  <ac:layout-cell>
   <p class="auto-cursor-target">
    <br/>
   </p>
   <ac:structured-macro ac:macro-id="0db3d9b8-3a8d-4ad4-ae26-0a4ea4bc95c2" ac:name="details" ac:schema-version="1">
    <ac:parameter ac:name="id">
     SIR-metadata
    </ac:parameter>
    <ac:rich-text-body>
     <p class="auto-cursor-target">
      <br/>
     </p>
     <table class="wrapped" style="letter-spacing: 0.0px;">
      <colgroup>
       <col/>
       <col/>
      </colgroup>
      <tbody>
       <tr>
        <th colspan="1">
         System/Service
        </th>
        <td colspan="1">
         <div class="content-wrapper">
          <p>
           <br/>
          </p>
         </div>
        </td>
       </tr>
       <tr>
        <th>
         Ticket(s)
        </th>
        <td>
         <div class="content-wrapper">
          <p>
           <ac:structured-macro ac:macro-id="e83cd8b4-bf08-4fc6-8eab-c82f1628c979" ac:name="jira" ac:schema-version="1">
            <ac:parameter ac:name="server">
             System JIRA
            </ac:parameter>
            <ac:parameter ac:name="columnIds">
             issuekey,summary,issuetype,created,updated,duedate,assignee,reporter,priority,status,resolution
            </ac:parameter>
            <ac:parameter ac:name="columns">
             key,summary,type,created,updated,due,assignee,reporter,priority,status,resolution
            </ac:parameter>
            <ac:parameter ac:name="serverId">
             ac6def98-2140-30c3-8103-4b52b8b31135
            </ac:parameter>
            <ac:parameter ac:name="key">
             ITINFRA-1943
            </ac:parameter>
           </ac:structured-macro>
           <ac:structured-macro ac:macro-id="c435e44b-f5a5-434e-9018-4a4b41edb585" ac:name="jira" ac:schema-version="1">
            <ac:parameter ac:name="server">
             System JIRA
            </ac:parameter>
            <ac:parameter ac:name="columnIds">
             issuekey,summary,issuetype,created,updated,duedate,assignee,reporter,priority,status,resolution
            </ac:parameter>
            <ac:parameter ac:name="columns">
             key,summary,type,created,updated,due,assignee,reporter,priority,status,resolution
            </ac:parameter>
            <ac:parameter ac:name="serverId">
             ac6def98-2140-30c3-8103-4b52b8b31135
            </ac:parameter>
            <ac:parameter ac:name="key">
             ITINFRA-1996
            </ac:parameter>
           </ac:structured-macro>
           <ac:structured-macro ac:macro-id="c78da89c-27eb-4a85-9e26-97bcfe8256f2" ac:name="jira" ac:schema-version="1">
            <ac:parameter ac:name="server">
             System JIRA
            </ac:parameter>
            <ac:parameter ac:name="serverId">
             ac6def98-2140-30c3-8103-4b52b8b31135
            </ac:parameter>
            <ac:parameter ac:name="key">
             ITINFRA-2229
            </ac:parameter>
           </ac:structured-macro>
          </p>
         </div>
        </td>
       </tr>
       <tr>
        <th colspan="1">
         Outage scope
        </th>
        <td colspan="1">
         NYC Routing
        </td>
       </tr>
       <tr>
        <th>
         Outage date
        </th>
        <td>
         <div class="content-wrapper">
          <p>
           Repeated incidents
          </p>
         </div>
        </td>
       </tr>
       <tr>
        <th>
         Report date
        </th>
        <td>
         <span style="color: rgb(0,82,204);">
          <time datetime="2023-10-31">
          </time>
          <br/>
         </span>
        </td>
       </tr>
       <tr>
        <th colspan="1">
         Report filed by
        </th>
        <td colspan="1">
         <div class="content-wrapper">
          <p>
           <ac:link>
            <ri:user ri:userkey="557058:c19c6239-8657-4845-b158-eec62442daf4">
            </ri:user>
           </ac:link>
          </p>
         </div>
        </td>
       </tr>
       <tr>
        <th colspan="1">
         Report reviewed date
        </th>
        <td colspan="1">
         <div class="content-wrapper">
          <p>
           <time datetime="2023-11-02">
           </time>
          </p>
         </div>
        </td>
       </tr>
       <tr>
        <th colspan="1">
         Reviewed by
        </th>
        <td colspan="1">
         <br/>
        </td>
       </tr>
      </tbody>
     </table>
     <p class="auto-cursor-target">
      <br/>
     </p>
    </ac:rich-text-body>
   </ac:structured-macro>
   <p class="auto-cursor-target">
    <br/>
   </p>
  </ac:layout-cell>
 </ac:layout-section>
 <ac:layout-section ac:type="single">
  <ac:layout-cell>
   <h2>
    Executive summary
   </h2>
   <hr/>
   <p>
    Various routes through NYC did not behave as expected, leading to path failures between sites using NYC as a routing hub.
   </p>
   <h2>
    <span>
     Background
    </span>
   </h2>
   <hr/>
   <p>
    NYC is our primary routing hub, and acts as a BGP route reflector. Route reflectors (RRs) share routing information between disconnected BGP neighbors, allowing for transitive multi-hop routes for low-traffic or infrequently used paths.
   </p>
   <p>
    <br/>
   </p>
   <p>
    Our other sites are all now managed by terraform, and NYC was the last holdout. This was due to a few factors, primarily the overall complexity of the firewall config.
   </p>
   <h2>
    Incident Description
   </h2>
   <hr/>
   <p>
    A large volume of BGP configuration was imported as-is to the NYC firewall. In early september, I made a focus on standardizing the NYC config to be consistent with our other sites. When certain conditions were met (changing from prefix-list to community routing) "shadow" rules would be created. This caused general havoc and confusion.
   </p>
   <h3>
    Chronology
   </h3>
   <p>
    <a href="https://github.com/schrodinger/tf-forti-nyc/commits/main/route-map.tf">
     https://github.com/schrodinger/tf-forti-nyc/commits/main/route-map.tf
    </a>
    <br/>
    <br/>
    This commit was likely the start of the issues.
    <a href="https://github.com/schrodinger/tf-forti-nyc/commit/69ee092d4f133bc51d4d599c14a6ea19b8479f1a">
     https://github.com/schrodinger/tf-forti-nyc/commit/69ee092d4f133bc51d4d599c14a6ea19b8479f1a
    </a>
   </p>
   <h3>
    Corrective Action
   </h3>
   <p>
    All relevant route-maps were deleted and recreated using terraform.
   </p>
   <h3>
    Analysis
   </h3>
   <p>
    It appears the conditions necessary for these "shadow" rules to be created are as follows:
   </p>
   <ol>
    <li>
     Import existing rule into terraform.
    </li>
    <li>
     Change from using
     <strong>
      <code>
       match_ip_address
      </code>
     </strong>
     to
     <strong>
      <code>
       match_community
      </code>
     </strong>
     like in
     <a href="https://github.com/schrodinger/tf-forti-nyc/commit/ce20c35954ec904bce3773a1e3d0071494ecaefa">
      https://github.com/schrodinger/tf-forti-nyc/commit/ce20c35954ec904bce3773a1e3d0071494ecaefa
     </a>
    </li>
   </ol>
   <p>
    <span style="letter-spacing: 0.0px;">
     When these changes are applied, the "shadow" rules will emerge - the fortios terraform provider will not enforce the removal of the existing
    </span>
    <span style="letter-spacing: 0.0px;">
     match_ip_address
    </span>
    <span style="letter-spacing: 0.0px;">
    </span>
   </p>
   <h2>
    Detection
   </h2>
   <hr/>
   <h3>
    How quickly was the problem detected?
   </h3>
   <p>
    This took us quite some time to correlate, but things were noticed relatively quickly - within a day for most cases.
   </p>
   <h3>
    How was the problem detected?
   </h3>
   <p>
    General analysis of related tickets for routing issues involving NYC.
   </p>
   <h3>
    How can detection be improved?
   </h3>
   <p>
    This is a tough one, as the issue is unlikely to reoccur - as a practice, the network team does not create route-maps by hand.
   </p>
   <h2>
    Response
   </h2>
   <hr/>
   <h3>
    How quickly did we respond once detected?
   </h3>
   <p>
    For the individual issues, within the sprint.
   </p>
   <h3>
    Did we adequately communicate to our users?
   </h3>
   <p>
    Outside of one case (path failure from aws-ld to mhg affecting build team) these issues were mostly noticed by us.
   </p>
   <h3>
    If not, how can this be improved?
   </h3>
   <p>
    I think we did well here.
   </p>
   <h2>
    Mitigation
   </h2>
   <hr/>
   <h3>
    What went well that helped minimize the impact of this problem?
   </h3>
   <p>
    Configuration was standardized, which made troubleshooting much easier. Declarative IaC provides documentation of intended config, which allowed easy cross-referencing with live config.
   </p>
   <h3>
    What can be done to minimize the impact if a problem like this recurs?
   </h3>
   <p>
    I'm looking into a YAML data structure that would support both ingestion by our terraform BGP module, and an ansible validation module. I'm also looking into methods of enforcing attribute status for unset attributes.
   </p>
   <h2>
    Avoidance
   </h2>
   <hr/>
   <h3>
    What can we do in the future to avoid a problem like this?
   </h3>
   <p>
    As the issue only occurs when correcting drift, minimizing drift and ad-hoc changes to the production environment would be the best approach.
   </p>
   <h2>
    Related articles
   </h2>
   <hr/>
   <p>
    <ac:placeholder>
     Related articles appear here based on the labels you select. Click to edit the macro and add or change labels.
    </ac:placeholder>
   </p>
   <p>
    <ac:structured-macro ac:macro-id="ffeb327a-3070-4405-823e-4605184c1568" ac:name="contentbylabel" ac:schema-version="4">
     <ac:parameter ac:name="showLabels">
      false
     </ac:parameter>
     <ac:parameter ac:name="max">
      5
     </ac:parameter>
     <ac:parameter ac:name="spaces">
      SYSMGR
     </ac:parameter>
     <ac:parameter ac:name="showSpace">
      false
     </ac:parameter>
     <ac:parameter ac:name="sort">
      modified
     </ac:parameter>
     <ac:parameter ac:name="reverse">
      true
     </ac:parameter>
     <ac:parameter ac:name="type">
      page
     </ac:parameter>
     <ac:parameter ac:name="cql">
      label = "kb-how-to-article" and type = "page" and space = "SYSMGR"
     </ac:parameter>
     <ac:parameter ac:name="labels">
      kb-how-to-article
     </ac:parameter>
    </ac:structured-macro>
   </p>
   <ac:structured-macro ac:macro-id="b77901a8-fc07-43f9-b345-36673b35c2e9" ac:name="details" ac:schema-version="1">
    <ac:parameter ac:name="hidden">
     true
    </ac:parameter>
    <ac:rich-text-body>
     <p class="auto-cursor-target">
      <br/>
     </p>
     <table class="wrapped">
      <colgroup>
       <col/>
       <col/>
      </colgroup>
      <tbody>
       <tr>
        <th>
         Related issues
        </th>
        <td>
         <br/>
        </td>
       </tr>
      </tbody>
     </table>
     <p class="auto-cursor-target">
      <br/>
     </p>
    </ac:rich-text-body>
   </ac:structured-macro>
   <p class="auto-cursor-target">
    <br/>
   </p>
  </ac:layout-cell>
 </ac:layout-section>
</ac:layout>
