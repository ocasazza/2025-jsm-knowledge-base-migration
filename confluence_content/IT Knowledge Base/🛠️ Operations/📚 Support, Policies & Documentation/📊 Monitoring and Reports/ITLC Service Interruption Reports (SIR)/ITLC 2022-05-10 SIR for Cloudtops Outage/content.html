<ac:layout>
 <ac:layout-section ac:type="single">
  <ac:layout-cell>
   <p>
    <br/>
   </p>
   <ac:structured-macro ac:macro-id="6041cfab-a8b7-40c8-aa32-0229b207b0df" ac:name="excerpt" ac:schema-version="1">
    <ac:parameter ac:name="atlassian-macro-output-type">
     INLINE
    </ac:parameter>
    <ac:rich-text-body>
     <p>
      SIR for Cloudtops outage via the teradici client. on 2021-11-22
     </p>
    </ac:rich-text-body>
   </ac:structured-macro>
   <p class="auto-cursor-target">
    <br/>
   </p>
  </ac:layout-cell>
 </ac:layout-section>
 <ac:layout-section ac:type="two_equal">
  <ac:layout-cell>
   <p class="auto-cursor-target">
    <br/>
   </p>
   <ac:structured-macro ac:macro-id="b2a57857-7f56-44d2-a0d4-91b3d7ebfcbf" ac:name="toc-zone" ac:schema-version="1">
    <ac:rich-text-body>
     <p>
      <ac:structured-macro ac:macro-id="58b18781-a929-4005-a5e0-2ef23adca3fe" ac:name="toc" ac:schema-version="1">
      </ac:structured-macro>
     </p>
    </ac:rich-text-body>
   </ac:structured-macro>
   <p class="auto-cursor-target">
    <br/>
   </p>
  </ac:layout-cell>
  <ac:layout-cell>
   <p class="auto-cursor-target">
    <br/>
   </p>
   <ac:structured-macro ac:macro-id="0db3d9b8-3a8d-4ad4-ae26-0a4ea4bc95c2" ac:name="details" ac:schema-version="1">
    <ac:parameter ac:name="id">
     SIR-metadata
    </ac:parameter>
    <ac:rich-text-body>
     <p class="auto-cursor-target">
      <br/>
     </p>
     <table class="wrapped" style="letter-spacing: 0.0px;">
      <colgroup>
       <col/>
       <col/>
      </colgroup>
      <tbody>
       <tr>
        <th colspan="1">
         System/Service
        </th>
        <td colspan="1">
         <ac:link>
          <ri:page ri:content-title="CloudTops" ri:space-key="SYSMGR">
          </ri:page>
         </ac:link>
        </td>
       </tr>
       <tr>
        <th>
         Ticket(s)
        </th>
        <td>
         <div class="content-wrapper">
          <p>
           <ac:structured-macro ac:macro-id="b9e618aa-23bd-4d37-bc55-57e2d4d298ab" ac:name="jira" ac:schema-version="1">
            <ac:parameter ac:name="server">
             System JIRA
            </ac:parameter>
            <ac:parameter ac:name="columnIds">
             issuekey,summary,issuetype,created,updated,duedate,assignee,reporter,priority,status,resolution
            </ac:parameter>
            <ac:parameter ac:name="columns">
             key,summary,type,created,updated,due,assignee,reporter,priority,status,resolution
            </ac:parameter>
            <ac:parameter ac:name="serverId">
             ac6def98-2140-30c3-8103-4b52b8b31135
            </ac:parameter>
            <ac:parameter ac:name="key">
             SYSMGR-65025
            </ac:parameter>
           </ac:structured-macro>
          </p>
         </div>
        </td>
       </tr>
       <tr>
        <th colspan="1">
         Outage scope
        </th>
        <td colspan="1">
         <span style="color: rgb(23,43,77);">
          DESIS/Hyderabad. All Cloudtop users.
         </span>
        </td>
       </tr>
       <tr>
        <th>
         Outage date
        </th>
        <td>
         <div class="content-wrapper">
          <p>
           <time datetime="2022-05-09">
           </time>
           <span style="color: rgb(23,43,77);">
           </span>
          </p>
         </div>
        </td>
       </tr>
       <tr>
        <th>
         Report date
        </th>
        <td>
         <div class="content-wrapper">
          <p>
           <time datetime="2022-05-09">
           </time>
           <span style="color: rgb(23,43,77);">
           </span>
          </p>
         </div>
        </td>
       </tr>
       <tr>
        <th colspan="1">
         Report filed by
        </th>
        <td colspan="1">
         <ac:link>
          <ri:user ri:userkey="557058:9290142c-5161-42cc-b65b-d8b8487fa532">
          </ri:user>
         </ac:link>
        </td>
       </tr>
       <tr>
        <th colspan="1">
         Report reviewed date
        </th>
        <td colspan="1">
         <div class="content-wrapper">
          <p>
           <time datetime="2022-05-23">
           </time>
           <span style="color: rgb(23,43,77);">
           </span>
          </p>
         </div>
        </td>
       </tr>
       <tr>
        <th colspan="1">
         Reviewed by
        </th>
        <td colspan="1">
         <div class="content-wrapper">
          <p>
           <ac:link>
            <ri:user ri:userkey="557058:898bb344-b31e-4ae9-b386-376a86469c7d">
            </ri:user>
           </ac:link>
           <ac:link>
            <ri:user ri:userkey="557058:c19c6239-8657-4845-b158-eec62442daf4">
            </ri:user>
           </ac:link>
          </p>
         </div>
        </td>
       </tr>
      </tbody>
     </table>
     <p class="auto-cursor-target">
      <br/>
     </p>
    </ac:rich-text-body>
   </ac:structured-macro>
   <p class="auto-cursor-target">
    <br/>
   </p>
  </ac:layout-cell>
 </ac:layout-section>
 <ac:layout-section ac:type="single">
  <ac:layout-cell>
   <h2>
    Executive summary
   </h2>
   <hr/>
   <p>
    On 09/05/22 at 12:53 AM EST Ravikiran Kuppuraj pinged the CloudTops Development chat room informing us that the PCoiP client connection was not working. The Teradici client failed to connect to the Connection Server. This server provided an invalid certificate.
   </p>
   <p>
    The certificate expired on 08/05/22 (DD/MM/YY).
    <span>
     <span style="letter-spacing: 0.0px;">
      <span>
       <span>
        05/22
       </span>
      </span>
     </span>
    </span>
   </p>
   <p>
    <br/>
   </p>
   <h2>
    <span>
     Background
    </span>
   </h2>
   <hr/>
   <p>
    <span style="color: rgb(23,43,77);">
     Cloudtops are virtual desktops that exist in the cloud and are delivered by cloud providers.Â  Schrodinger cloud provider for our Cloudtop virtual machines is GCP. These Virtual instances are primarily used by our Dev and QA teams in India.
    </span>
   </p>
   <h2>
    Incident Description
   </h2>
   <hr/>
   <p>
    The Gateway certificate expired for the Cloudtops CAC server on May 7th 2022, since that was on a Saturday we didn't get notified until very early Monday morning the 9th. Users received an error when trying to connect to cloudtops:
   </p>
   <p>
    <ac:image ac:height="400">
     <ri:attachment ri:filename="cloudtops-cert-err.png">
     </ri:attachment>
    </ac:image>
   </p>
   <p>
    <br/>
   </p>
   <h3>
    Chronology
   </h3>
   <ul>
    <li>
     On May 9th at 12:41 AM EST, Ravikiran Kuppuraj commented in the Cloudtops Development chatroom. Ravikiran Kuppuraj received an invalid certificate error when trying to connect to the cloudtops instance.
    </li>
    <li>
     At 12:43 EST Ravikiran Kuppuraj opened a Jira ticket for this issue.
     <a class="issue-link" href="https://schrodinger.atlassian.net/browse/SYSMGR-64622" style="letter-spacing: 0.0px;">
      SYSMGR-64622
     </a>
     .
    </li>
    <li>
     Multiple users followed up shortly after letting us know that they are encountering the same issue.
    </li>
    <li>
     <ac:link>
      <ri:user ri:userkey="712020:be0141d8-2f03-45a8-8a4e-3cdd257f9a2a">
      </ri:user>
     </ac:link>
     commented in the IT-SOS room at 2:24 Am EST letting us know that users were unable to access the
     <span style="color: rgb(32,33,36);">
      Teradici PCoIP Client due to
     </span>
     <a class="oiM5sf" href="http://cloudtops.sdgr.io/" style="text-decoration: none;">
      Cloudtops.sdgr.io
     </a>
     <span style="color: rgb(32,33,36);">
      certificate being expired.
     </span>
    </li>
    <li>
     <span style="color: rgb(32,33,36);">
      <ac:link>
       <ri:user ri:userkey="640b97dd93cf25994632639f">
       </ri:user>
      </ac:link>
      responded at 6:09 AM requesting for
      <ac:link>
       <ri:user ri:userkey="557058:898bb344-b31e-4ae9-b386-376a86469c7d">
       </ri:user>
      </ac:link>
      and
      <ac:link>
       <ri:user ri:userkey="557058:9290142c-5161-42cc-b65b-d8b8487fa532">
       </ri:user>
      </ac:link>
      to look into the issue.
     </span>
    </li>
    <li>
     <ac:link>
      <ri:user ri:userkey="640b97dd93cf25994632639f">
      </ri:user>
     </ac:link>
     responded at 6:14 AM EST informing the users that some one on the team will look into the issue.
    </li>
    <li>
     <ac:link>
      <ri:user ri:userkey="557058:898bb344-b31e-4ae9-b386-376a86469c7d">
      </ri:user>
     </ac:link>
     and
     <ac:link>
      <ri:user ri:userkey="557058:9290142c-5161-42cc-b65b-d8b8487fa532">
      </ri:user>
     </ac:link>
     Started to investigate.
    </li>
    <li>
     <ac:link>
      <ri:user ri:userkey="557058:9290142c-5161-42cc-b65b-d8b8487fa532">
      </ri:user>
     </ac:link>
     looked through the gcp-service-project in Gitlab for clues as to how the certificate was applied.
    </li>
    <li>
     We reached out to
     <ac:link>
      <ri:user ri:userkey="557058:8aff9fa7-fab5-4a58-8371-4bbe29336cd2">
      </ri:user>
     </ac:link>
     and
     <ac:link>
      <ri:user ri:userkey="5d405c8181cbd30da3475cdf">
      </ri:user>
     </ac:link>
     to further assist as this process was not documented and required additional effort.
    </li>
    <li>
     At 2:03 PM EST we applied the updated Gateway certification but noticed it was not updated across files.
    </li>
    <li>
     <ac:link>
      <ri:user ri:userkey="5d405c8181cbd30da3475cdf">
      </ri:user>
     </ac:link>
     Found the command on the Teradici website which applied the updated SSL certification.
    </li>
   </ul>
   <h3>
    Corrective Action
   </h3>
   <p>
    Looking at the gitlab repo for the cloudtops, more specifically, connector &gt; scripts &gt; connector-nodnsmasq.sh:
    <a href="https://gitlab.schrodinger.com/sysmgr/service-projects/gcp-service-project-cloudtop/-/blob/master/connector/scripts/connector-nodnsmasq.sh">
     gcp-service-project-cloudtop
    </a>
    we had to ultimately run the cert update script on the cac-mumbai-0 gcp vm:
   </p>
   <ac:structured-macro ac:macro-id="af7791f7-f5df-4093-95e8-82c8c46c3f57" ac:name="code" ac:schema-version="1">
    <ac:plain-text-body>
     <![CDATA[sudo /root/.acme.sh/acme.sh --force --issue --standalone -d $fqdn]]>
    </ac:plain-text-body>
   </ac:structured-macro>
   <p>
    Running the acme.sh script required that we stop the docker daemon and socket service so it can receive the updated cert. Since the docker service was set to always restart, we copied the docker.service file from:
    <strong>
     /lib/systemd/system
    </strong>
    to
    <strong>
     /etc/systemd/system
    </strong>
    as that takes precedence. We then were able to comment out references to restarting the service in that file. Then we were able to:
   </p>
   <ac:structured-macro ac:macro-id="644a0e61-947e-41ec-a1ce-db54e8ed30d9" ac:name="code" ac:schema-version="1">
    <ac:plain-text-body>
     <![CDATA[systemctl stop docker.service
systemctl disable docker.service]]>
    </ac:plain-text-body>
   </ac:structured-macro>
   <p>
    Once the docker service was stopped, we were able to successfully run the above acme.sh command to update the cert.
    <strong>
     $fqdn
    </strong>
    for the cac-mumbai-0 instance is:
    <strong>
     cloudtops.sdgr.io
    </strong>
   </p>
   <p>
    Once new certs were generated, you then have to delete the docker.service file at
    <strong>
     /etc/systemd/system
    </strong>
    and re-enable the docker.service and restart both docker.socket and docker.service services so that the cloudtop containers can start running.
   </p>
   <p>
    Even though we got new certs, we STILL have to run a cloud-access-connector update command to make sure those certs are in the right directories.
   </p>
   <p>
    /usr/sbin/cloud-access-connector update --ssl-cert
   </p>
   <p>
    You can check to see if the cert locations have been updated by entering into the docker proxy container and checking the nginx cert:
   </p>
   <p>
    <br/>
   </p>
   <ac:structured-macro ac:macro-id="d8329e96-b589-4697-894c-4713c79d644e" ac:name="code" ac:schema-version="1">
    <ac:plain-text-body>
     <![CDATA[docker exec -it <container name> /bin/bash
nginx@1596764d0d92:/$ cd /etc/nginx/certs/
openssl x509 -in cert.crt -text | more]]>
    </ac:plain-text-body>
   </ac:structured-macro>
   <p>
    <br/>
   </p>
   <p>
    We also had to make sure the mumbai cac server had a static non-ephemeral IP address in GCP, and that the appropriate IP address was in NS1.
   </p>
   <h3>
    Analysis
   </h3>
   <p>
    <span style="color: rgb(32,33,36);">
     We have to shut down the docker instances to renew the ssl cert. We need to find a way to renew the ssl cert without needing port 80. Once that's done, full auto renewal would be possible.
    </span>
   </p>
   <p>
    <span style="color: rgb(32,33,36);">
     No documentation was in confluence in regards to this process.
    </span>
   </p>
   <p>
    <br/>
   </p>
   <h2>
    Detection
   </h2>
   <hr/>
   <h3>
    How quickly was the problem detected?
   </h3>
   <p>
    We were notified 41 minutes after the certificate expired on May 9th in the Cloudtops Development chatroom by
    <span style="color: rgb(32,33,36);">
     Ravikiran Kuppuraj.
    </span>
   </p>
   <p>
    <br/>
   </p>
   <h3>
    How was the problem detected?
   </h3>
   <p>
    <span style="color: rgb(32,33,36);">
     Ravikiran Kuppuraj pinged the Cloudtops Development chatroom informing us that the certificate expired. Additional user's reported it shortly after.
    </span>
   </p>
   <h3>
    How can detection be improved?
   </h3>
   <p>
    Better monitoring, Updating IT-Event Calendar with this Cert renewal expiration date. Automate ticket creation to renew the certificate before expiration.
   </p>
   <h2>
    Response
   </h2>
   <hr/>
   <h3>
    How quickly did we respond once detected?
   </h3>
   <p>
    The incident was reported after working hours for the NYC team. This was unexpected and there wasn't much documentation in regards to renewing the certificate.
   </p>
   <h3>
    Did we adequately communicate to our users?
   </h3>
   <p>
    Yes, We communicated clearly in the Cloudtops Development and IT-Support Chatrooms.
   </p>
   <h3>
    If not, how can this be improved?
   </h3>
   <p>
    Create an email group for all Cloudtops users and send out email communication to all affected users.
   </p>
   <p>
    <br/>
   </p>
   <h2>
    Mitigation
   </h2>
   <hr/>
   <h3>
    What went well that helped minimize the impact of this problem?
   </h3>
   <p>
    Great team work when it came time to find the solution to the problem.
   </p>
   <h3>
    What can be done to minimize the impact if a problem like this recurs?
   </h3>
   <p>
    Create documentation for the certificate renewal process. Create a cron job that can automatically renew the certificate before it expires.
   </p>
   <h2>
    Avoidance
   </h2>
   <hr/>
   <h3>
    What can we do in the future to avoid a problem like this?
   </h3>
   <p>
    Documentation, Automation and weekly reminder on the IT Events Calendar.
   </p>
   <p>
    <br/>
   </p>
   <h2>
    Next Actions
   </h2>
   <hr/>
   <p>
    <br/>
   </p>
   <ac:task-list>
    <ac:task>
     <ac:task-id>
      1
     </ac:task-id>
     <ac:task-status>
      complete
     </ac:task-status>
     <ac:task-body>
      <span class="placeholder-inline-tasks">
       <ac:link>
        <ri:user ri:userkey="557058:898bb344-b31e-4ae9-b386-376a86469c7d">
        </ri:user>
       </ac:link>
       <ac:link>
        <ri:user ri:userkey="557058:9290142c-5161-42cc-b65b-d8b8487fa532">
        </ri:user>
       </ac:link>
       <ac:link>
        <ri:user ri:userkey="557058:c19c6239-8657-4845-b158-eec62442daf4">
        </ri:user>
       </ac:link>
       Document the certificate renewal procedure.
      </span>
     </ac:task-body>
    </ac:task>
    <ac:task>
     <ac:task-id>
      2
     </ac:task-id>
     <ac:task-status>
      complete
     </ac:task-status>
     <ac:task-body>
      <span class="placeholder-inline-tasks">
       <ac:link>
        <ri:user ri:userkey="557058:9290142c-5161-42cc-b65b-d8b8487fa532">
        </ri:user>
       </ac:link>
       Update IT Event Calendar with Certificate Expiration dates.
      </span>
     </ac:task-body>
    </ac:task>
    <ac:task>
     <ac:task-id>
      3
     </ac:task-id>
     <ac:task-status>
      incomplete
     </ac:task-status>
     <ac:task-body>
      <span>
      </span>
     </ac:task-body>
    </ac:task>
   </ac:task-list>
   <p>
    <br/>
   </p>
   <h2>
    Related articles
   </h2>
   <hr/>
   <p>
    <ac:placeholder>
     Related articles appear here based on the labels you select. Click to edit the macro and add or change labels.
    </ac:placeholder>
   </p>
   <p>
    <ac:structured-macro ac:macro-id="ffeb327a-3070-4405-823e-4605184c1568" ac:name="contentbylabel" ac:schema-version="4">
     <ac:parameter ac:name="showLabels">
      false
     </ac:parameter>
     <ac:parameter ac:name="max">
      5
     </ac:parameter>
     <ac:parameter ac:name="spaces">
      SYSMGR
     </ac:parameter>
     <ac:parameter ac:name="showSpace">
      false
     </ac:parameter>
     <ac:parameter ac:name="sort">
      modified
     </ac:parameter>
     <ac:parameter ac:name="reverse">
      true
     </ac:parameter>
     <ac:parameter ac:name="type">
      page
     </ac:parameter>
     <ac:parameter ac:name="cql">
      label = "kb-how-to-article" and type = "page" and space = "SYSMGR"
     </ac:parameter>
     <ac:parameter ac:name="labels">
      kb-how-to-article
     </ac:parameter>
    </ac:structured-macro>
   </p>
   <ac:structured-macro ac:macro-id="b77901a8-fc07-43f9-b345-36673b35c2e9" ac:name="details" ac:schema-version="1">
    <ac:parameter ac:name="hidden">
     true
    </ac:parameter>
    <ac:rich-text-body>
     <p class="auto-cursor-target">
      <br/>
     </p>
     <table class="wrapped">
      <colgroup>
       <col/>
       <col/>
      </colgroup>
      <tbody>
       <tr>
        <th>
         Related issues
        </th>
        <td>
         <br/>
        </td>
       </tr>
      </tbody>
     </table>
     <p class="auto-cursor-target">
      <br/>
     </p>
    </ac:rich-text-body>
   </ac:structured-macro>
   <p class="auto-cursor-target">
    <br/>
   </p>
  </ac:layout-cell>
 </ac:layout-section>
</ac:layout>
